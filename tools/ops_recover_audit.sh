#!/bin/sh
set -u
cd "
H
O
M
E
/
a
s
t
r
o
"
∣
∣
e
x
i
t
1
R
D
I
R
=
"
HOME/astro"∣∣exit1RDIR="HOME/astro/logs/recovery.
(
d
a
t
e
+
(date+RDIR"
date -Is > "
R
D
I
R
/
a
n
c
h
o
r
.
t
x
t
"
I
S
=
RDIR/anchor.txt"IS=(git rev-parse --is-inside-work-tree 2>/dev/null || echo false)
BR=-; HI=-; DEF=; AH=-; BH=-; RH=-
if [ "
I
S
"
=
t
r
u
e
]
;
t
h
e
n
B
R
=
IS"=true];thenBR=(git branch --show-current 2>/dev/null || echo -)
HI=
(
g
i
t
l
o
g
−
1
−
−
f
o
r
m
a
t
=
′
i
f
g
i
t
r
e
m
o
t
e
∣
g
r
e
p
−
q
′
o
r
i
g
i
n
(gitlog−1−−format= 
′
 ifgitremote∣grep−q 
′o
 rigin'; then
DEF=(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's#.*/##' || true) git fetch origin --prune >/dev/null 2>&1 || true if [ -n "DEF" ]; then
RH=
(
g
i
t
l
o
g
−
1
−
−
f
o
r
m
a
t
=
′
(gitlog−1−−format= 
′
 DEF" 2>/dev/null || echo -)
C=
(
g
i
t
r
e
v
−
l
i
s
t
−
−
l
e
f
t
−
r
i
g
h
t
−
−
c
o
u
n
t
H
E
A
D
.
.
.
"
o
r
i
g
i
n
/
(gitrev−list−−left−right−−countHEAD..."origin/DEF" 2>/dev/null || echo "0 0")
AH={C% *}; BH={C#* }
fi
fi
fi
ENV="
H
O
M
E
/
a
s
t
r
o
/
c
h
a
t
k
i
t
/
c
a
n
o
n
i
c
a
l
/
02
p
a
t
h
s
.
e
n
v
"
;
[
−
f
"
HOME/astro/chatkit/canonical/02 
p
​
 aths.env";[−f"ENV" ] && . "
E
N
V
"
∣
∣
t
r
u
e
B
A
S
E
=
"
ENV"∣∣trueBASE="{GD_BASE:-HOME/astro/base}"; OVER="{GD_OVERLAY_TEST:-HOME/astro/overlay_test}"; STAGE="{GD_STAGE:-HOME/astro/stage}" cnt(){ [ -d "1" ] && find "1" -type f | wc -l | tr -d ' ' || echo 0; } b=( [ -d "BASE" ] && echo yes || echo no ) o=( [ -d "OVER" ] && echo yes || echo no ) s=( [ -d "STAGE" ] && echo yes || echo no ) { echo '--- SUMMARY ---' echo "RDIR=RDIR"
echo "GIT=
I
S
b
r
a
n
c
h
=
ISbranch=BR head=[
H
I
]
"
e
c
h
o
"
O
R
I
G
I
N
d
e
f
=
HI]"echo"ORIGINdef={DEF:-'-'} ahead=
A
H
b
e
h
i
n
d
=
AHbehind=BH rhead=[
R
H
]
"
e
c
h
o
"
B
A
S
E
=
RH]"echo"BASE=BASE (
b
f
i
l
e
s
=
bfiles=(cnt "
B
A
S
E
"
)
)
"
e
c
h
o
"
O
V
E
R
L
A
Y
=
BASE"))"echo"OVERLAY=OVER (
o
f
i
l
e
s
=
ofiles=(cnt "
O
V
E
R
"
)
)
"
e
c
h
o
"
S
T
A
G
E
=
OVER"))"echo"STAGE=STAGE (
s
f
i
l
e
s
=
sfiles=(cnt "STAGE"))" echo '--- SUMMARY ---' } | tee "RDIR/summary.txt"
